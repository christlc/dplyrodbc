---
title: "R tools for Manifold via ODBC and dplyr"
author: "Michael D. Sumner"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R tools for Manifold via ODBC and dplyr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE,message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-", 
  fig.height = 9,
  fig.width = 9
)
library(raster)
```

## dplyrodbc

Here we illustrate connecting to a Manifold project via ODBC. 
First with direct `RODBC` connection and conversion to `Spatial` types, then via `dplyr` wrapping for the SQL backend. 

## Minimal test for RODBC

This code shows the tradtional way to read data from a Manifold project using `RODBC`. 


```{r}
library(RODBC)
library(dplyrodbc)
mapfile <- system.file("extdata", "Countries.map", package = "dplyrodbc")
con <- odbcConnectManifold(mapfile)
tab <- "Countries"
cnames <- names(sqlQuery(con, sprintf("SELECT * FROM [%s] WHERE 0 = 1", tab)))
## Drop all Intrinsic columns (we cast one to GeomWKB)
cnames <- cnames[-grep("\\(I\\)", cnames)]
## some columns explode the app, presumably "Geom (I)" because of the size of the binary blob
dat <- sqlQuery(con, sprintf("SELECT CoordSysToWKT(CCoordSys([Geom (I)])) AS [CoordSys], CGeomWKB([Geom (I)]) as [GeomWKB], %s FROM [%s]", 
                           paste(dplyrodbc:::sql_squote(cnames), collapse = ", "), tab), stringsAsFactors = FALSE)

close(con)
```


The data.frame `x` has all the attributes, the Coordinate System (in OGC WKT format), and the Geometry as a binary blob (in OGC WKB format). 

We don't want to look at the binary blob, so convert it to `sp` Spatial Geometry and discard. We can't deal with the WKT without awful kludges, so we skip it for now. 

```{r}

geom <- try(wkb::readWKB(dat$GeomWKB))
if (!inherits(geom, "try-error")) {
  dat$GeomWKB <- NULL
  
  ## save full handling for another day (mixed CRS?)
  wkt <- unique(dat$CoordSys)
  proj4 <- dplyrodbc:::prj_to_epsg(wkt[1])
  dat$CoordSys <- NULL
  proj4string(geom) <-  proj4
  dwg <- sp::SpatialPolygonsDataFrame(geom, dat)
  rm(dat, geom, proj4)
}

plot(dwg)
text(coordinates(dwg), lab = dwg$FIPS)


print(dwg)
```


## Connecting to the ODBC SQL engine via dplyr

We need some fixes to RODBCDBI. 

```{r}
##devtools::install_github("mdsumner/RODBCDBI",   ref = "mike")
library(RODBCDBI)
```


Methods for our specific  classes extending `DBI` for ODBC. 

```{r}
library(dplyrodbc)  ## move this to manifoldr when it's working
library(dplyr)
```

And Manifold. 

```{r}
## not clear how to do this yet
## we need cases for odbcConnectWhatever
#' @export
setMethod(
  "dbConnect", 
  "ODBCDriver", 
  function(drv, dsn, user = NULL, password = NULL, ..., manifold = FALSE){
    uid <- if(is.null(user)) "" else user
    pwd <- if(is.null(password)) "" else password
    if (manifold) {
      connection <- odbcConnectManifold(dsn) 
    } else {
      connection <- odbcConnect(dsn, uid, pwd, ...)
    }
    new("ODBCConnection", odbc=connection)
  }
)



src_manifold <- function(dbname = NULL, host = NULL, port = NULL, user = NULL,
                         password = NULL, ...) {
  
  con <-    dbConnect(RODBCDBI::ODBC(), dbname, manifold = TRUE)
  
  src_sql("manifold", con)
}



src_desc.src_manifold <- function(con) {
  info <- dbGetInfo(con$con)
  host <- if (info$host == "") "localhost" else info$host

  paste0("manifold ", info$serverVersion, " [", info$user, "@",
         host, ":", info$port, "/", info$dbname, "]")
}


db_list_tables.src_manifold <- function(con) {
  dbListTables(con$con)
}

db_has_table.src_manifold <- function(con, table) {
  dbExistsTable(con$con, table)
}

tbl.src_manifold <- function(src, from, ...) {
  tbl_sql("manifold", src = src, from = from, ...)
}

src_translate_env.src_manifold <- dplyr:::src_translate_env.NULL





manifold <-src_manifold(mapfile)
## woah, not cool
# ct <- tbl(manifold, "Countries Table")
#  Show Traceback
#  
#  Rerun with Debug
#  Error in odbcQuery(channel, query, rows_at_time) : 
#   'Calloc' could not allocate memory (2147483648 of 1 bytes) 

## Try with innocuous table
 ct <- tbl(manifold, "Countries Table")

 ## collect, summarize, etc. don't work yet
# a <- collect(ct %>% group_by(`Branches (I)`) %>% select(`Longitude (I)`, `Latitude (I)` ))
# Error in .valueClassTest(ans, "data.frame", "fetch") : 
#   invalid value from generic function ‘fetch’, class “character”, expected “data.frame”
# 

```




